function BxSimpleMessenger(){this.chatBoxSettings=new Object(),this.oDefinedChatBoxes=new Object(),this.systemMessages=new Object(),this.isSent=true,this.bFirstRender=false,this.isProcessed=true;this.mCorkHandler="";this.isProcessedBlocked=false;this.sendMessage=function(g,f,c){var a=this;if(!this.isSent){alert(this.systemMessages.waitMessage);return false}if(!g){if(window.event){g=window.event}else{return false}}var h=g.keyCode?g.keyCode:g.charCode;if(h==13){if(g.preventDefault){g.preventDefault()}else{g.returnValue=false}var b=$.trim($(f).attr("value"));if(!b){alert(this.systemMessages.emptyMessage)}else{var d=Math.random();this.isSent=false;this.isProcessedBlocked=true;clearTimeout(this.chatBoxSettings.updateTimeNotifyHandler);this.chatBoxSettings.updateTimeNotifyHandler="";$.post(this.chatBoxSettings.sPageReceiver+"/send_message/"+c+"&_r="+d,{message:encodeURIComponent(b)},function(i){a.isSent=true;var e=a;if(i){alert(i)}else{$(f).attr("value","");a.loadMessageBlock(c,function(){var j=$("#"+a.chatBoxSettings.sHistoryBlockPrefix+c);if(j.css("visibility")=="hidden"){a.showChatWindow(a.chatBoxSettings.sHistoryBlockPrefix+c,j.parent())}})}a.isProcessedBlocked=false;a.messageNotification()})}return false}return true},this.loadMessageBlock=function(b,d){var a=this;if(!this.checkChatBox(b)){var c=Math.random();$.get(this.chatBoxSettings.sPageReceiver+"/get_chat_box/"+b+"&_r="+c,function(e){a.proccesReceivedData(e);if(typeof d!="undefined"){d()}})}else{if(typeof d!="undefined"){d()}}},this.messageNotification=function(g){if(this.isProcessedBlocked){return}if(!this.isProcessed){this.cork()}else{var c=this;var b=this.oDefinedChatBoxes.boxes.length;var a=0;var e=Math.random();var f="";for(var d=0;d<b;d++){a=this.oDefinedChatBoxes.boxes[d].last_message;f+=this.oDefinedChatBoxes.boxes[d].box_id+":"+a+","}$.getJSON(this.chatBoxSettings.sPageReceiver+"/new_messages&_r="+e,{registered_chat_boxes:f},function(h){c.proccesReceivedData(h);if(typeof g!="undefined"){g()}if(c.isProcessed&&!c.isProcessedBlocked){c.chatBoxSettings.updateTimeNotifyHandler=setTimeout(function(){c.messageNotification()},c.chatBoxSettings.updateTime)}})}},this.cork=function(){var a=this;if(this.isProcessed&&!a.isProcessedBlocked){clearInterval(this.mCorkHandler);this.messageNotification()}else{this.mCorkHandler=setTimeout(function(){a.cork()},100)}},this.stopBlink=function(a){if(typeof this.oDefinedChatBoxes.boxes[a]!="undefined"){clearInterval(this.oDefinedChatBoxes.boxes[a].blink_handler);this.oDefinedChatBoxes.boxes[a].blink_handler="";this.oDefinedChatBoxes.boxes[a].blink_value=""}},this.setBlinkMode=function(b,f){var a=this;try{if(typeof($("#chatAudio"))=="undefined"){$('<audio id="chatAudio"><source src="http://hayoou.qiniudn.com/WjJW2wGz2iZjX6_rBUXcIDjmUZY=/Fkvbep1RBwPLOkcHneBz-90ro8eS" type="audio/mpeg"></audio>').appendTo("body")}$("#chatAudio")[0].play()}catch(d){}var c=setInterval(function(){a.oDefinedChatBoxes.boxes[b].blink_handler=c;if(!a.oDefinedChatBoxes.boxes[b].blink_value){a.oDefinedChatBoxes.boxes[b].blink_value=0}var e=f.parents("."+a.chatBoxSettings.sChatBox+":first");e.addClass("active_chat_block_blink_effect");setTimeout(function(){e.removeClass("active_chat_block_blink_effect");a.oDefinedChatBoxes.boxes[b].blink_value++;if(a.oDefinedChatBoxes.boxes[b].blink_value>=a.chatBoxSettings.iMaxBlinkCounter){if(!e.hasClass("active_chat_block_blink_effect")){e.addClass("active_chat_block_blink_effect")}a.stopBlink(b);return}},500)},1000)},this.elScroll=function(a){iHeight=this.getChatBoxContentHeight(a);a.scrollTop(iHeight)},this.proccesReceivedData=function(c){if(this.isProcessedBlocked){return}if(c){this.isProcessed=false;var q=this;var e=c.senders.length;for(var k=0;k<e;k++){var b=c.senders[k].sender_id;if(!b){continue}var d=this.getChatBoxObjectIndex(b);var m=false;if(!this.checkChatBox(b)){this.oDefinedChatBoxes.boxes[this.oDefinedChatBoxes.boxes.length]={box_id:b,status:c.senders[k].sender_status,status_text_update:c.senders[k].status_update_time,blink_handler:0,blink_value:0,last_message:parseInt(c.senders[k].last_message),count_messages:c.senders[k].count_messages};m=true}if(c.senders[k].chat_box&&m){$("#"+this.chatBoxSettings.sOutputBlockId).append(c.senders[k].chat_box)}var l=$("#"+this.chatBoxSettings.sHistoryBlockPrefix+b);var r=l.find("div.messages_section:first");if(c.senders[k].messages_list){if(c.senders[k].messages_list!="built-in"){var h=r.outerHeight();var p=this.getChatBoxContentHeight(r);var a=this.getVisibility(r);if((a=="hidden"&&!this.oDefinedChatBoxes.boxes[d].blink_handler)||m){this.setBlinkMode(d,r)}r.append(c.senders[k].messages_list);p=p-h;if(p<=r.scrollTop()&&a=="visible"){this.elScroll(r)}if(this.oDefinedChatBoxes.boxes[d].count_messages>this.chatBoxSettings.iNumberVisibleMessages){var o=$("#"+this.chatBoxSettings.sHistoryBlockPrefix+c.senders[k].sender_id+" div.messages_section").children();var n=o.length;var g=n-this.chatBoxSettings.iNumberVisibleMessages;this.oDefinedChatBoxes.boxes[d].count_messages-=g;for(var f=0;f<g;f++){$("#"+this.chatBoxSettings.sHistoryBlockPrefix+c.senders[k].sender_id+" div.messages_section > div:first-child").remove()}}}else{if(this.bFirstRender&&c.senders[k].messages_list=="built-in"){if(this.getVisibility(r)!="visible"){this.setBlinkMode(d,r)}}}}if(typeof this.oDefinedChatBoxes.boxes[d]!="undefined"&&!m){if(this.oDefinedChatBoxes.boxes[d].status_text_update!=c.senders[k].status_update_time){this.getStatusText(b);this.oDefinedChatBoxes.boxes[d].status_text_update=c.senders[k].status_update_time}if(this.oDefinedChatBoxes.boxes[d].status!=c.senders[k].sender_status){this.getSenderStatus(b);this.oDefinedChatBoxes.boxes[d].status=c.senders[k].sender_status}this.oDefinedChatBoxes.boxes[d].last_message=parseInt(c.senders[k].last_message);if(c.senders[k].count_messages){this.oDefinedChatBoxes.boxes[d].count_messages+=parseInt(c.senders[k].count_messages)}}}this.isProcessed=true}if(!this.bFirstRender){this.bFirstRender=true}},this.getVisibility=function(a){var b=a.css("visibility");if(b=="inherit"){b=a.parent().css("visibility")}return b},this.getChatBoxContentHeight=function(a){var b=0;a.children(":not(.emojiPicker)").each(function(){b=b+$(this).outerHeight()});return b},this.checkChatBox=function(c){var a=this.oDefinedChatBoxes.boxes.length;for(var b=0;b<a;b++){if(this.oDefinedChatBoxes.boxes[b].box_id==c){return 1}}return 0},this.getChatBoxObjectIndex=function(d){var a=this.oDefinedChatBoxes.boxes.length;var b=0;for(var c=0;c<a;c++){if(this.oDefinedChatBoxes.boxes[c].box_id==d){return b=c}}return b},this.showChatWindow=function(a,g){var c=$("#"+a);var f=this;c.find("input").addEmojiInput({wrapper:$("#"+a).find(".messages_section"),onhide:function(h){var i=c.find("div.messages_section:first");f.elScroll(i)}});if(typeof g=="undefined"){var g=$("#"+a).parent()}if(c.css("visibility")=="visible"||c.css("visibility")=="inherit"){$(g).removeClass("active_chat_block");c.css("visibility","hidden")}else{var d=a.replace(/[^0-9]*/,"");var b=this.getChatBoxObjectIndex(d);this.stopBlink(b);$(g).addClass("active_chat_block");$(g).removeClass("active_chat_block_blink_effect");if(this.chatBoxSettings.sMemberMenuPosition=="bottom"){c.css("bottom",this.chatBoxSettings.iParentContainerHeight)}else{c.css("top",this.chatBoxSettings.iParentContainerHeight)}c.css({visibility:"visible",left:c.position().left-(c.offset().left<0?c.offset().left:0)});this.placeTop(a,this)}var e=c.find("div.messages_section:first");this.elScroll(e)},this.facePlate=function(b,a,c){jQuery.each(jQuery.browser,function(d){if($.browser.msie){b.cancelBubble=true}else{b.stopPropagation()}});if(typeof c!="undefined"){c(a,this)}},this.placeTop=function(e,c){var b=0;var a=0;$("#"+c.chatBoxSettings.sOutputBlockId+" div."+c.chatBoxSettings.sChatBox).each(function(){a=parseInt($(this).css("z-index"));if(b<a){b=a}});b+=1;if(typeof e!="object"){var d=$("#"+e)}else{var d=$(e)}d.css("z-index",b);d.parent().css("z-index",b)},this.closeChatWindow=function(b){var c=Math.random();var a=this;$.get(this.chatBoxSettings.sPageReceiver+"/close_window/"+b,{_r:c},function(d){var f=a.oDefinedChatBoxes.boxes.length;for(var e=0;e<f;e++){if(typeof a.oDefinedChatBoxes.boxes[e]!="undefined"&&a.oDefinedChatBoxes.boxes[e].box_id==b){a.oDefinedChatBoxes.boxes.splice(e,1);$("#"+a.chatBoxSettings.sHistoryBlockPrefix+b).parent().remove()}}})},this.getStatusText=function(a){var b=Math.random();$("#"+this.chatBoxSettings.sHistoryBlockPrefix+a).find(".status_text").load(this.chatBoxSettings.sPageReceiver+"/get_status_text/"+a+"&_r="+b)},this.getSenderStatus=function(b){var a=this;var c=Math.random();$.get(this.chatBoxSettings.sPageReceiver+"/get_status/"+b,{_r:c},function(d){$("#"+a.chatBoxSettings.sHistoryBlockPrefix+b).parent().find(".sender_status").attr("src",d);a.getSenderThumbnail(b)})},this.getSenderThumbnail=function(a){var b=Math.random();$("#"+this.chatBoxSettings.sHistoryBlockPrefix+a).parent().find(".sender_thumb").load(this.chatBoxSettings.sPageReceiver+"/get_sender_thumb/"+a+"&_r="+b)}}var oSimpleMessenger=new BxSimpleMessenger();

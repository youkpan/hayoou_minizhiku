$.fn.bxdolcmtanim=function(action,effect,speed,h){return this.each(function(){var sFunc="";var sEval;if(0==speed){effect="default"}switch(action){case"show":switch(effect){case"slide":sFunc="slideDown";break;case"fade":sFunc="fadeIn";break;default:sFunc="show"}break;case"hide":switch(effect){case"slide":sFunc="slideUp";break;case"fade":sFunc="fadeOut";break;default:sFunc="hide"}break;default:case"toggle":switch(effect){case"slide":sFunc="slideToggle";break;case"fade":sFunc=($(this).filter(":visible").length)?"fadeOut":"fadeIn";break;default:sFunc="toggle"}}if((0==speed||undefined==speed)&&undefined==h){sEval="$(this)."+sFunc+"();"}else{if((0==speed||undefined==speed)&&undefined!=h){sEval="$(this)."+sFunc+"(); $(this).each(h);"}else{sEval="$(this)."+sFunc+"('"+speed+"', h);"}}eval(sEval);return this})};function BxDolCmts(a){this._sObjName=undefined==a.sObjName?"oCmts":a.sObjName;this._sSystem=a.sSystem;this._sSystemTable=a.sSystemTable;this._iAuthorId=a.iAuthorId;this._iObjId=a.iObjId;this._sOrder=a.sOrder=="asc"||a.sOrder=="desc"?a.sOrder:"asc";this._sActionsUrl=a.sBaseUrl+"cmts.php";this._sVideoActionsUrl=a.sBaseUrl+"flash/XML.php";this._sDefaultErrMsg=undefined==a.sDefaultErrMsg?_t("_Error occured"):a.sDefaultErrMsg;this._sConfirmMsg=undefined==a.sConfirmMsg?_t("_Are_you_sure"):a.sConfirmMsg;this._isEditAllowed=parseInt(undefined==a.isEditAllowed?0:a.isEditAllowed);this._isRemoveAllowed=parseInt(undefined==a.isRemoveAllowed?0:a.isRemoveAllowed);this._iSecsToEdit=parseInt(undefined==a.iSecsToEdit?0:a.iSecsToEdit);this._bAutoHideRootPostForm=parseInt(undefined==a.iAutoHideRootPostForm?0:a.iAutoHideRootPostForm);this._sAnimationEffect=undefined==a.sAnimationEffect?"slide":a.sAnimationEffect;this._iAnimationSpeed=undefined==a.sAnimationSpeed?"slow":a.sAnimationSpeed;this._iGlobAllowHtml=undefined==a.iGlobAllowHtml?"0":a.iGlobAllowHtml;this._oCmtElements=undefined==a.oCmtElements?{}:a.oCmtElements;this._oSavedTexts={};if($("#cmts-box-"+this._sSystem+"-"+this._iObjId+" .cmt-post-reply form").length){$("#cmts-box-"+this._sSystem+"-"+this._iObjId+" .cmt-post-reply form")[0].reset();$("#cmts-box-"+this._sSystem+"-"+this._iObjId+" .cmt-post-reply form > [name=CmtParent]").val(0)}var b=this;$("#cmts-box-"+this._sSystem+"-"+this._iObjId).click(function(d){var c=0;var g=$(d.target).parent();if(g.hasClass("cmt-pos")){c=1;d.preventDefault()}else{if(g.hasClass("cmt-neg")){c=-1;d.preventDefault()}}if(c!=0&&!$(d.target).parents(".cmt-rate").hasClass("cmt-rate-disabled")){var f=$(d.target).parents(".cmt-buttons").siblings(".cmt-points").children("span").get();b._rateComment(f,parseInt(g.attr("id").substr(8)),c)}})}BxDolCmts.prototype.changeOrder=function(a){var b=$(a);this._sOrder=b.val();this._getCmts(b.siblings(":last"),0,function(){})};BxDolCmts.prototype.expandAll=function(b){var a=this;$.each($("#cmts-box-"+this._sSystem+"-"+this._iObjId+" .cmts > .cmts > .cmt > .cmt-cont .cmt-replies-show"),function(){$(this).trigger("click")})};BxDolCmts.prototype.changePerPage=function(c){var b=$("#cmts-box-"+this._sSystem+"-"+this._iObjId+" > .cmt-browse > .cmt-order > :last").get();var a=parseInt(c.value);this._getCmts(b,0,function(){},0,a);this._getPaginate(b,0,a)};BxDolCmts.prototype.changePage=function(a,b){var c=$("#cmts-box-"+this._sSystem+"-"+this._iObjId+" > .cmt-browse > .cmt-order > :last").get();this._getCmts(c,0,function(){},a,b);this._getPaginate(c,a,b)};BxDolCmts.prototype.showReplacement=function(a){$("#cmt"+a+"-hidden").bxdolcmtanim("hide",this._sAnimationEffect,this._iAnimationSpeed,function(){$(this).next("#cmt"+a).bxdolcmtanim("show",this._sAnimationEffect,this._iAnimationSpeed)})};BxDolCmts.prototype.reloadComment=function(a){var b=this;var d=this._getDefaultActions();d.action="CmtGet";d.Cmt=a;d.Type="reload";var c=$("#cmts-box-"+b._sSystem+"-"+b._iObjId+" > div.cmts > ul").get();this._loading(c,true);jQuery.post(this._sActionsUrl,d,function(e){b._loading(c,false);$("#cmts-box-"+b._sSystem+"-"+b._iObjId+" li#cmt"+a).bxdolcmtanim("hide",b._sAnimationEffect,b._iAnimationSpeed,function(){$(this).replaceWith(e)})})};BxDolCmts.prototype.toggleReply=function(c,a){if(a==0){if($("#cmts-box-"+this._sSystem+"-"+this._iObjId+" .cmt-reply").children().length){$("#cmts-box-"+this._sSystem+"-"+this._iObjId+" .cmt-reply").bxdolcmtanim("toggle",this._sAnimationEffect,this._iAnimationSpeed)}else{var b=this;var d=this._getDefaultActions();d.action="FormGet";d.CmtType="comment";d.CmtParent=a;b._loading(c,true);jQuery.post(this._sActionsUrl,d,function(e){b._loading(c,false);$("#cmts-box-"+b._sSystem+"-"+b._iObjId+" .cmt-reply").append($(e).addClass("cmt-post-reply-expanded").css("display","none")).children(".cmt-post-reply").bxdolcmtanim("toggle",b._sAnimationEffect,b._iAnimationSpeed)})}}else{if($("#cmt"+a).children(".cmt-post-reply").length){$("#cmt"+a).children(".cmt-post-reply").bxdolcmtanim("toggle",this._sAnimationEffect,this._iAnimationSpeed)}else{var b=this;var d=this._getDefaultActions();d.action="FormGet";d.CmtType="reply";d.CmtParent=a;b._loading(c,true);jQuery.post(this._sActionsUrl,d,function(e){b._loading(c,false);$("#cmt"+a).children(".cmt-cont").after($(e).addClass("cmt-post-reply-expanded").css("display","none")).next(".cmt-post-reply").bxdolcmtanim("toggle",b._sAnimationEffect,b._iAnimationSpeed)})}}};BxDolCmts.prototype.toggleType=function(c){var b={"cmt-post-reply-text":"cmt-post-reply-video","cmt-post-reply-video":"cmt-post-reply-text"};var a=$(c).hasClass("cmt-post-reply-text")?"cmt-post-reply-text":"cmt-post-reply-video";if($(c).parents(".cmt-balloon").find("div."+a).is(":hidden")){$(c).addClass("inactive").parents(".cmt-balloon").find("div."+b[a]).bxdolcmtanim("hide",this._sAnimationEffect,this._iAnimationSpeed,function(){var d=a.substring(a.lastIndexOf("-")+1,a.length);$(c).siblings(":visible.inactive").removeClass("inactive");$(this).siblings("[name = CmtType]").val(d);$(this).siblings("div."+a).bxdolcmtanim("show",this._sAnimationEffect,this._iAnimationSpeed);if(d=="video"){$(this).siblings(".cmt-post-reply-post").children(":submit").attr("disabled","disabled")}else{$(this).siblings(".cmt-post-reply-post").children(":submit").removeAttr("disabled")}})}};BxDolCmts.prototype.toggleCmts=function(c,b){if(b==0){$(c).parents("#cmts-box-"+this._sSystem+"-"+this._iObjId+":first").find(".cmt-comments").toggle();if(!$(c).parents("#cmts-box-"+this._sSystem+"-"+this._iObjId+":first").find("div.cmts > ul > li").length){this._getCmts(c,b,function(){})}else{$(c).parents("#cmts-box-"+this._sSystem+"-"+this._iObjId+":first").find("div.cmts").bxdolcmtanim("toggle",this._sAnimationEffect,this._iAnimationSpeed)}}else{var a="#cmt"+b;if($(a+" > ul").length){if($(a+" > ul").is(":visible")){$(a+" > ul").bxdolcmtanim("hide",this._sAnimationEffect,this._iAnimationSpeed,function(){$(a+"  > .cmt-cont .cmt-replies-hide").hide().siblings(".cmt-replies-show").show()})}else{$(a+" > ul").bxdolcmtanim("show",this._sAnimationEffect,this._iAnimationSpeed,function(){$(a+"  > .cmt-cont .cmt-replies-show").hide().siblings(".cmt-replies-hide").show()})}}else{this._getCmts(c,b,function(){$(a+" > .cmt-cont .cmt-replies-show").hide().siblings(".cmt-replies-hide").show()})}}};BxDolCmts.prototype.cmtRemove=function(c,a){var b=this;$(document).dolPopupConfirm({message:this._sConfirmMsg,onClickYes:function(){var d=b._getDefaultActions();d.action="CmtRemove";d.Cmt=a;b._loading(c,true);jQuery.post(b._sActionsUrl,d,function(e){b._loading(c,false);if(jQuery.trim(e).length){alert(e)}else{$("#cmt"+a).bxdolcmtanim("hide",b._sAnimationEffect,b._iAnimationSpeed,function(){$(this).remove()})}})}})};BxDolCmts.prototype.cmtEdit=function(d,b){var c=this;var a=$("#cmt"+b+" .cmt-body:first");if(a.find("textarea.cmt-text-edit").length){a.bxdolcmtanim("hide",c._sAnimationEffect,c._iAnimationSpeed,function(){if(c._iGlobAllowHtml==1){c.editorDestroy($(this).find("textarea.cmt-text-edit[name='CmtText']"))}$(this).html(c._oSavedTexts[b]).bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed)});return}var f=this._getDefaultActions();f.action="CmtEdit";f.Cmt=b;this._oSavedTexts[b]=a.html();jQuery.post(this._sActionsUrl,f,function(e){if(e.substring(0,3)=="err"){alert(e.substring(3));return}a.bxdolcmtanim("hide",c._sAnimationEffect,c._iAnimationSpeed,function(){var g=$(this).html(e).find("[name='CmtMood']");if(g.size()){g.find("[value='"+$.trim($("#cmt"+b+" .cmt-mood:first").html())+"']").attr("checked","checked")}$(this).bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed)})})};BxDolCmts.prototype._getPaginate=function(d,a,b){var c=this;var f=this._getDefaultActions();f.action="PaginateGet";if(a!=undefined){f.CmtStart=a}if(b!=undefined){f.CmtPerPage=b}this._loading(d,true);jQuery.post(this._sActionsUrl,f,function(e){$("#cmts-box-"+c._sSystem+"-"+c._iObjId+" .cmt-show-more").bxdolcmtanim("hide",c._sAnimationEffect,c._iAnimationSpeed,function(){if(e.length>0){$(this).find(".paginate").remove();$(this).append(e);$(this).bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed)}});c._loading(d,false)})};BxDolCmts.prototype._getCmts=function(g,d,c,a,b){var f=this;var h=this._getDefaultActions();h.action="CmtsGet";h.CmtParent=d;h.CmtOrder=this._sOrder;if(a){h.CmtStart=a}if(b){h.CmtPerPage=b}if(g){this._loading(g,true)}jQuery.post(this._sActionsUrl,h,function(e){if(d==0){$(g).parents("#cmts-box-"+f._sSystem+"-"+f._iObjId+":first").find(".cmts > ul").bxdolcmtanim("hide",f._sAnimationEffect,f._iAnimationSpeed,function(){$(this).replaceWith(e).bxdolcmtanim("show",f._sAnimationEffect,f._iAnimationSpeed,function(){$(this).find("a.bx-link").dolEmbedly()})})}else{$(g).parents("#cmt"+d+":first").append($(e).filter(".cmts").addClass("cmts-margin").hide()).children(".cmts").bxdolcmtanim("show",f._sAnimationEffect,f._iAnimationSpeed,function(){$(this).find("a.bx-link").dolEmbedly()})}c();f._loading(g,false)})};BxDolCmts.prototype._getCmt=function(e,b,a){var c=this;var g=this._getDefaultActions();g.action="CmtGet";g.Cmt=a;var f=$(e).parents("#cmts-box-"+c._sSystem+"-"+c._iObjId+":first");var d=f.find("div.cmts > ul").get();this._loading(d,true);jQuery.post(this._sActionsUrl,g,function(i){c._loading(d,false);if(b==0){var h=function(){var k=f.find("div.cmts > ul");var j=parseInt(f.find(".cmt-comments:first .cmt-comments-count").html());if(k.children("li.cmt:last").length){f.find(".cmt-comments .cmt-comments-count").html(j+1);if(k.is(":visible")){k.append($(i).hide()).find("li.cmt:hidden").bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed,function(){$(this).find("a.bx-link").dolEmbedly()})}else{k.append(i).parents("div.cmts:first").bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed,function(){$(this).find("a.bx-link").dolEmbedly()})}}else{if(j>0){c._getCmts(e,0,function(){f.find(".cmt-comments").toggle().find(".cmt-comments-count").html(j+1)})}else{k.find(".cmt-no").remove();k.html(i).find("a.bx-link").dolEmbedly()}}};if(c._bAutoHideRootPostForm){f.find(".cmt-reply").bxdolcmtanim("hide",c._sAnimationEffect,c._iAnimationSpeed,function(){h()})}else{h()}}else{f.find("#cmt"+b+" > .cmt-post-reply").bxdolcmtanim("hide",c._sAnimationEffect,c._iAnimationSpeed,function(){var j=parseInt(f.find("#cmt"+b+" > .cmt-cont .cmt-replies-count").html());if(!f.find("#cmt"+b+" > ul").length&&!j){$(i).wrap($("<ul />").addClass("cmts").addClass("cmts-margin")).parent().hide().appendTo(f.find("#cmt"+b)).bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed,function(){$(this).find("a.bx-link").dolEmbedly()})}else{if(!f.find("#cmt"+b+" > ul").length&&j>0){c._getCmts(e,b,function(){f.find("#cmt"+b+" > .cmt-cont .cmt-replies").toggle().find(".cmt-replies-count").html(j+1)})}else{if(f.find("#cmt"+b+" > ul").length){f.find("#cmt"+b+" > .cmt-cont .cmt-replies .cmt-replies-count").html(j+1);if(f.find("#cmt"+b+" > ul").is(":visible")){f.find("#cmt"+b+" > ul").append($(i).hide());f.find("#cmt"+b+" > ul > :last").bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed,function(){$(this).find("a.bx-link").dolEmbedly()})}else{f.find("#cmt"+b+" > ul").append(i).bxdolcmtanim("show",c._sAnimationEffect,c._iAnimationSpeed,function(){$(this).find("a.bx-link").dolEmbedly()})}}}}})}c._runCountdown(a)})};BxDolCmts.prototype.submitComment=function(c){var a=$(c).children().find(":submit").get();var d=this;var g=this._getDefaultActions();d._err(a,false);d._disableButton(a,true);var e=($(c).children("[name = CmtType]").val()=="video");if(!e&&!this._getCheckElements(c,g)){d._disableButton(a,false);return}if(e){var b=parseInt($(c).children("[name = CmtParent]").val());g.module="video_comments";g.action="post";g.system=this._sSystem;g.parent=b;g.id=this._iObjId;g.author=this._iAuthorId;g.mood=$(c).find(".cmt-post-reply-mood :input:checked").val()}else{g.action="CmtPost"}this._loading(a,true);jQuery.post(e?this._sVideoActionsUrl:this._sActionsUrl,g,function(f){d._loading(a,false);d._disableButton(a,false);var i=parseInt(f);if(i>0){if(e){d._getCmt(c,b,i);var h=getRecorderObject(c);if(h.removeRecord!=undefined){h.removeRecord()}}else{$(c).find(":input:not(:button,:submit,[type = hidden],[type = radio],[type = checkbox])").val("");d._getCmt(c,g.CmtParent,i)}}else{if(!jQuery.trim(f).length){d._err(a,true,d._sDefaultErrMsg)}else{d._err(a,true,f)}}})};BxDolCmts.prototype.updateComment=function(c,b){var a=$(c).find(":submit").get();var d=this;var e=this._getDefaultActions();d._err(a,false);if(!this._getCheckElements(c,e)){return}this._oSavedTexts[b]="";e.action="CmtEditSubmit";e.Cmt=b;this._loading(a,true);jQuery.post(this._sActionsUrl,e,function(g){d._loading(a,false);if(!jQuery.trim(g.text).length){d._err(a,true,jQuery.trim(g.err).length?g.err:d._sDefaultErrMsg);return}var f=$("#cmt"+b+" .cmt-body:first");f.bxdolcmtanim("hide",d._sAnimationEffect,d._iAnimationSpeed,function(){if(d._iGlobAllowHtml==1){d.editorDestroy(f.find("textarea.cmt-text-edit[name='CmtText']"))}f.find(".cmt-mood").html(" "+g.mood+" ");f.find(".cmt-mood-text").html(g.mood_text);$(this).html(g.text).bxdolcmtanim("show",d._sAnimationEffect,d._iAnimationSpeed)})},"json")};BxDolCmts.prototype._toggleHidden=function(b,a){$("#cmt"+a+" > .cmt-cont").bxdolcmtanim("toggle",this._sAnimationEffect,this._iAnimationSpeed)};BxDolCmts.prototype._rateComment=function(d,a,b){var c=this;var f=this._getDefaultActions();f.action="CmtRate";f.Cmt=a;f.Rate=b;this._loading(d,true);jQuery.post(this._sActionsUrl,f,function(e){c._loading(d,false);if(jQuery.trim(e).length){alert(e)}else{if(b==1){$(d).html(parseInt($(d).html())+b);$(d).parent().parent().addClass("cmt-rate-disabled")}else{if(b==-1){c.reloadComment(a)}}}})};BxDolCmts.prototype._getCheckElements=function(b,d){var c=this;var a=true;jQuery.each($(b).find(":input"),function(){if(this.name.length&&c._oCmtElements[this.name]){var g=true;if(c._oCmtElements[this.name]["reg"]){try{if(this.type=="textarea"&&c._iGlobAllowHtml==1){var f=new RegExp(c._oCmtElements[this.name]["reg"]);g=f.test(c.editorGetText($(this)).replace(/(\n|\r)/g,""))}else{var f=new RegExp(c._oCmtElements[this.name]["reg"]);g=f.test(this.value.replace(/(\n|\r)/g,""))}}catch(e){}}if(!g){a=false;c._err(this,true,c._oCmtElements[this.name]["msg"])}else{c._err(this,false)}if(this.type=="textarea"&&c._iGlobAllowHtml==1){d[this.name]=c.editorGetText($(this))}else{if(this.type=="radio"){if(this.checked){d[this.name]=this.value}}else{d[this.name]=this.value}}}});return a};BxDolCmts.prototype._runCountdown=function(a){if(this._isEditAllowed||this._isRemoveAllowed||0==this._iSecsToEdit){return}$("#cmt-jp-"+a+" span > b").html(this._iSecsToEdit);window.setTimeout(this._sObjName+".onCountdown("+a+","+this._iSecsToEdit+");",1000)};BxDolCmts.prototype.onCountdown=function(b,a){var a=parseInt($("#cmt-jp-"+b+" span > b").html());if(0==--a){$("#cmt-jp-"+b).remove();return}else{$("#cmt-jp-"+b+" span > b").html(a);window.setTimeout(this._sObjName+".onCountdown("+b+","+a+");",1000)}};BxDolCmts.prototype._disableButton=function(a,c){var b=$(a);if(c){b.attr("disabled","disabled").addClass("bx-btn-disabled")}else{b.removeClass("bx-btn-disabled").removeAttr("disabled")}};BxDolCmts.prototype._loading=function(b,a){if(a&&!$(b).parent().find("b").length){$(b).parent().append(" <b>"+aDolLang._sys_txt_cmt_loading+"</b>")}else{if(!a&&$(b).parent().find("b").length){$(b).parent().find("b").remove()}}};BxDolCmts.prototype._err=function(c,a,b){if(a&&!$(c).next(".cmt-err").length){$(c).after(' <b class="cmt-err">'+b+"</b>")}else{if(!a&&$(c).next(".cmt-err").length){$(c).next(".cmt-err").remove()}}};BxDolCmts.prototype._getDefaultActions=function(){return{sys:this._sSystem,id:this._iObjId}};BxDolCmts.prototype.editorGetText=function(a){if(typeof tinyMCE=="undefined"||!$(a).is("textarea")){return}return a.html()};BxDolCmts.prototype.editorDestroy=function(a){if(typeof tinyMCE=="undefined"||!$(a).is("textarea")){return}a.tinymce().remove()};

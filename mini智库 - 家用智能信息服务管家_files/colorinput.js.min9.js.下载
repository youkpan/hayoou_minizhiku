(function(c){c.fn.colorInput=function(d){d=jQuery.extend(c.colorInput.defaults,d);this.each(function(){c(this).data("colorControl",new c.colorInput(this,d))});return this};c.fn.colorSelected=function(d){if(d){this.bind("colorSelected",d);return this}else{this.trigger("colorSelected")}};c.fn.colorAccept=function(d){if(d){this.bind("colorAccept",d);return this}else{this.trigger("colorAccept")}};c.fn.colorCancel=function(d){if(d){this.bind("colorCancel",d);return this}else{this.trigger("colorCancel")}};c.colorInput=function(u,n){var g=c(u);if(g.data("colorControl")!=null){return this}var q=this,t=n.cells*n.cellSize,l=n.cells*n.cellSize+n.hueWidth;var C="<button ".concat("class='colorButton' style='width:",n.hueWidth,"px;height:",n.hueWidth,"px;margin:0;padding:0;border:none 0;line-height:",n.hueWidth-2,"px'>&nbsp;</button>");var o=c(C),v,F,E;g.after(o);o.click(function(K){if(c.colorInput.current==q){m()}else{if(c.colorInput.current){c.colorInput.current.cancel()}else{H()}}K.stopPropagation();return false});var h=c("#".concat(n.dropdownId));if(h.length==1){if(n.acceptCancelButtons){v=h.find(".colorButtons");F=v.find(":eq(0)");E=v.find(":eq(1)")}}else{h=c("<div ".concat("id='",n.dropdownId,"' class='colorDropdown' style='display:none;position:absolute;overflow:visible;height:0;margin:0;padding:0;cursor:pointer'></div>")).append(c("<div ".concat("style='float:left;width:",t,"px;height:",t,"px;margin:0;padding:0'></div>")).append(a(n)).append(b(n)));if(n.acceptCancelButtons){F=c(C).text(n.textAccept).css({width:Math.round(t/2)});E=c(C).text(n.textCancel).css({width:Math.round(t/2)});v=c("<div ".concat("class='colorButtons' style='position:absolute;z-index:0;left:0;width=",t,"px;height:",n.hueWidth,"px'></div>")).append(F).append(E);h.prepend(v)}c(document.body).append(h)}var J=h.find(".saturationBrightnessMap"),f=h.find(".hueMap"),x=new c.colorInput.color(),D,z,d=false;if(n.hideInput){g.hide()}var w;var r=function(M){if(w){clearTimeout(w);w=null}if(M){w=setTimeout(r,M);return}var O=x.hue*t-Math.round(x.hue*t);var L=new c.colorInput.color(0,1,1);B(null);f.find("div").each(function(){L.hue=O/t;this.hue=L.hue;this.color=L.toHex();this.style.backgroundColor=this.color;if(this.hue==x.hue){B(this)}O++});var N=0,K=0;L=new c.colorInput.color(x.hue,0,0);j(null);J.find("div").each(function(){L.saturation=1-N/(n.cells-1);L.brightness=1-K/(n.cells-1);this.saturation=L.saturation;this.brightness=L.brightness;this.color=L.toHex();this.style.backgroundColor=this.color;if(this.color==D){j(this)}N++;if(N==n.cells){N=0;K++}})};var e=function(){var K=g.find("input[type=text]").val();if(K!=D){x.fromHex(K);I(K,d)}};var I=function(L,K){D=L;g.find("input[type=text]").val(L);q.isChanged=z&&L!=z;o.css({backgroundColor:L.length>0?L:"#000000",color:x.brightnessContrast().toHex()});if(n.acceptCancelButtons){F.css({backgroundColor:L,color:x.brightnessContrast().toHex()})}if(K){r(n.hoverSelect?50:0)}};var m=function(){if(z!=D){g.change()}z=null;s()};var k=function(){if(q.isChanged){g.find("input[type=text]").val(z);e();g.colorSelected()}z=null;s()};var s=function(){c.each(n.cancelOnClick,function(){c(this).unbind("click.color")});f.find("div").unbind("mousedown").unbind("mousemove").unbind("mouseup").unbind("click");J.find("div").unbind("mousedown").unbind("mousemove").unbind("mouseup").unbind("click");J.unbind("dblclick");h.unbind("click");if(n.acceptCancelButtons){v.animate({marginTop:0},{duration:125});F.unbind("click");E.unbind("click")}f.animate({marginLeft:t-n.hueWidth},{duration:125,complete:function(){f.css({display:"none"});h.animate({height:0,width:0},{duration:250,complete:function(){h.css({display:"none"})}})}});c.colorInput.current=null;q.isChanged=false;d=false};var H=function(){z=D;if(n.acceptCancelButtons){F.add(E).css({backgroundColor:D,color:x.brightnessContrast().toHex()})}r();c.each(n.cancelOnClick,function(){c(this).bind("click.color",k)});if(n.hoverSelect){f.find("div").mousemove(function(L){p(this);g.colorSelected()});J.find("div").mousemove(function(L){i(this);g.colorSelected()});J.dblclick(function(L){m();L.stopPropagation();return false});J.click(function(L){m();L.stopPropagation();return false})}else{f.find("div").mousedown(function(L){return y(L,f)}).mousemove(function(L){if(G(L,f)){p(this);g.colorSelected()}}).mouseup(function(L){A(L,f)}).click(function(L){p(this);g.colorSelected()});J.find("div").mousedown(function(L){return y(L,J)}).mousemove(function(L){if(G(L,J)){i(this);g.colorSelected()}}).mouseup(function(L){A(L,J)}).click(function(L){i(this);g.colorSelected()});J.dblclick(function(L){m();L.stopPropagation();return false})}h.click(function(L){L.stopPropagation();return false});var K=o.offset();h.css({display:"",top:K.top+o.height()+"px",left:K.left+(n.showLeft?-t:0)+"px"}).animate({height:t,width:t},{duration:500,complete:function(){f.css({display:""}).animate({marginLeft:t},{duration:250});if(n.acceptCancelButtons){v.animate({marginTop:-n.hueWidth},{duration:250});F.click(function(L){m();L.stopPropagation();return false});E.click(function(L){k();L.stopPropagation();return false})}}});c.colorInput.current=q;d=true};if(c.browser.msie){h.attr("unselectable","on");h.find("div").attr("unselectable","on")}var y=function(L,K){if(K.data("drag")){A(L,K)}K.data("drag",true);return false};var A=function(L,K){K.data("drag",false)};var G=function(L,K){if(!K.data("drag")){return false}if(c.browser.msie&&!L.button){A(L,K);return false}return true};var B=function(K){var L=f.data("selected");if(L){L.style.zIndex=0;L.style.width=n.hueWidth+"px";L.style.margin="0";L.style.border="none 0"}f.data("selected",K);if(K){K.style.zIndex=1;K.style.width=(n.hueWidth-2)+"px";K.style.margin="-1px 0";K.style.border="solid 1px #000"}};var p=function(K){x.hue=K.hue;I(x.toHex(),d)};var j=function(K){var L=J.data("selected");if(L){L.style.width=n.cellSize+"px";L.style.height=n.cellSize+"px";L.style.border="none 0"}J.data("selected",K);if(K){K.style.width=(n.cellSize-2)+"px";K.style.height=(n.cellSize-2)+"px";K.style.border="solid 1px ".concat(x.brightnessContrast().toHex())}};var i=function(K){x.saturation=K.saturation;x.brightness=K.brightness;I(x.toHex(),false);j(K)};g.bind("change",e);g.bind("colorAccept",m);g.bind("colorCancel",k);if(n.change){g.change(n.change)}if(n.colorSelected){g.colorSelected(n.colorSelected)}this.accept=m;this.cancel=k;this.isChanged=false;e();return this};function b(e){var f=["<div class='saturationBrightnessMap' style='position:absolute;z-index:1;overflow:hidden;width:",e.cells*e.cellSize,"px;height:",e.cells*e.cellSize,"px'>"];for(var d=0;d<e.cells;d++){for(var g=0;g<e.cells;g++){f.push("<div ".concat("style='float:left;overflow:hidden;width:",e.cellSize,"px;height:",e.cellSize,"px;border:none 0'></div>"))}}f.push("</div>");return f.join("")}function a(e){var d=["<div class='hueMap' style='position:absolute;z-index:0;width:",e.hueWidth,"px;height:",e.cells*e.cellSize,"px'>"];for(var f=0;f<e.cells*e.cellSize;f++){d.push("<div style='float:left;position:relative;overflow:hidden;width:",e.hueWidth,"px;height:1px;border:none 0'>&nbsp;</div>")}d.push("</div>");return d.join("")}c.colorInput.defaults={acceptCancelButtons:true,cancelOnClick:[document],cells:15,cellSize:10,change:null,colorSelected:null,dropdownId:"ColorDropdown",hideInput:true,hoverSelect:false,hueWidth:20,noHash:false,showLeft:false,textAccept:"ok",textCancel:"cancel"};c.colorInput.current=null;c.colorInput.color=function(d,e,f){if(arguments.length==1&&d.constructor==String){this.fromHex(d)}else{this.hue=parseFloat(d)||0;this.saturation=parseFloat(e)||0;this.brightness=parseFloat(f)||0}this.isValid=function(){if(isNaN(this.hue)){return false}while(this.hue>1){this.hue-=1}while(this.hue<0){this.hue+=1}if(isNaN(this.saturation)){return false}if(this.saturation>1){this.saturation=1}else{if(this.saturation<0){this.saturation=0}}if(isNaN(this.brightness)){return false}if(this.brightness>1){this.brightness=1}else{if(this.brightness<0){this.brightness=0}}return true};this.isValid();this.brightnessContrast=function(){return new c.colorInput.color(0,0,this.brightness>=0.75?0:1)};this.valueToHex=function(h){var g=Math.round(h*255).toString(16);return g.length==1?"0"+g:g};this.hexToValue=function(g){return parseInt(g,16)/255};this.fromHex=function(i){if(i.slice(0,1)=="#"){i=i.slice(1)}if(i.length==3){i=i.split("");i=i[0]+i[0]+i[1]+i[1]+i[2]+i[2]}if(i.length!=6){this.brightness=NaN;return}var k=this.hexToValue(i.substr(0,2));var j=this.hexToValue(i.substr(2,2));var g=this.hexToValue(i.substr(4,2));this.brightness=Math.max(Math.max(k,j),g);var h=Math.min(Math.min(k,j),g);if(h==this.brightness){this.hue=0;this.saturation=0}else{var l=this.brightness-h;this.saturation=l/this.brightness;if(k==this.brightness){this.hue=(j-g)/l}else{if(j==this.brightness){this.hue=2+((g-k)/l)}else{this.hue=4+((k-j)/l)}}this.hue/=6;if(this.hue<0){this.hue+=1}if(this.hue>1){this.hue-=1}}return this};this.toHex=function(o){if(!this.isValid()){return"Transparent"}var j,k,n;var l=Math.floor(this.hue*6);var m=(this.hue*6)-l;var h=this.brightness*(1-this.saturation);var g=this.brightness*(1-(this.saturation*m));var r=this.brightness*(1-(this.saturation*(1-m)));switch(l){case 1:j=g;k=this.brightness;n=h;break;case 2:j=h;k=this.brightness;n=r;break;case 3:j=h;k=g;n=this.brightness;break;case 4:j=r;k=h;n=this.brightness;break;case 5:j=this.brightness;k=h;n=g;break;case 6:case 0:j=this.brightness;k=r;n=h;break}return o?"":"#"+this.valueToHex(j)+this.valueToHex(k)+this.valueToHex(n)}}})(jQuery);
